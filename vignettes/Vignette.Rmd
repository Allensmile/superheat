---
title: '`superheat`: An R package for generating supervised heatmaps'
author: "Rebecca Barter"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
header-includes: \usepackage{graphicx}
vignette: |
  %\VignetteIndexEntry{Using the superheat package for visually assessing  data and model fitting} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---


## Introduction 

The `superheat` package was developed to produce supervised heatmaps which act as a data exploration tool designed to visually explore complex datasets and assess the fit of data models. The highly customisable image is generated by combining a clustered heatmap with scatterplots with the aim of both visualizing the information contained in our data as well as assessing the adequacy of models fit to our data.



--------


## Downloading and installing the package


```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  error = FALSE,
  tidy = FALSE
)
```



<!--# Using the modelfit package for assessing the fit of a model. -->

The goal of this guide is to help you understand how and why to use the `superheat` package in R to assess your data model of interest. First, you need to download and install the package. This can be done using the `devtools` package. If you have not yet done so, you will need to download it. The `devtools` package allows the user to download and install packages hosted on github pages, such as this one. To do this for most systems you need to type the following code into your R console:


```{r, eval = FALSE}
install.packages("devtools")
devtools::install_github("rlbarter/superheat")
```




Next, you can load the `superheat` library into your workspace:

```{r}
library(superheat)

```


--------

## The contents of the plot

As mentioned above, the primary aim of this package is to produce a supervised heatmap that can be used to both explore your data and diagnose areas of your data where your model may be performing sub-optimally (and to gives clues about possible improvements). The plot consists of two elements:

1. *a clustered heatmap*: a clustered version of the $(n \times p)$ design matrix ${\bf X}$).

1. *a plot above and to the right of the heatmap*: these plots could be scatterplots, barplots, scatterplots with a smoothed curve, isolated smoothed curves and line plots.

1. *cluster or variable labels below and to the left of the heatmap*: these labels correspond to the cluster numbers/names or the variable names.



--------------

## Things you should keep in mind
The heatmap in the center of the plot is of a matrix, ${\bf X}$, in which, by default, the rows are clustered into a number of distinct clusters. The colour scale is presented below the heatmap. 


--------

## Usage

The package consists of a single function: `superheat`. 

The `superheat` function takes data objects, the most important of which are `X` (the heatmap matrix), `yr` (a vector of values to be plotted to the right of the heatmap) and `yt` (a vector of values to be plotted above the heatmap), although both `yr` and `yt` are optional. For example, the plot could be generated for the famous `iris` dataset as follows

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
# define a linear model and isolate coefficients for each variable
iris.coef <- lm(Petal.Length ~ Sepal.Length + Sepal.Width + Petal.Width, data = iris)$coef

# generate the plot:
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], # heatmap matrix
            yr = iris[,"Petal.Length"], #plot Petal.Length to the right
            yr.axis.name = "Petal.Length",
            membership.rows = iris[,"Species"], # cluster the rows by species
            yt = iris.coef[-1], # plot the model coefficients above
            yt.plot.type = "bar", # make the plot above a barplot
            yt.axis.name = "coefficient")
```

This plot shows us a heatmap of the design matrix, $X$, which consists of 150 rows (the first 10 of which are shown below) and 3 variables (the first three columns of the table below). We also have a species variable (the fourth column of the table below) that we are using as our cluster membership identifier. Finally, on the right hand side of the plot we are plotting a fourth variable `Sepal.Length`. We can see from this plot that the virginica species has longer petals and sepals than *Setosa* which has short sepals and particularly short petal width.

```{r, echo = FALSE, results = "asis"}
pander::pandoc.table(iris[1:10,c("Sepal.Width","Sepal.Length","Petal.Width", "Species")])
```



Further, if you are one of those people who prefer their design matrix to be $n \times p$ instead of $p \times n$, we can accomodate you too! For example, we are plotting a heatmap of the transpose of $X$, as well as the `Sepal.Length` variable above (`yt` corresponds to the variable to be plotted on *top* of the heatmap and `yr` corresponds to the variable to be plotted to the *right* of the heatmap). Note that below we must specify `cluster.rows = FALSE`, since the default is to cluster the rows but not the columns.

```{r, fig.align='center',fig.height = 7, fig.width = 5.5,  fig.show = 'hold'}

superheat(X = t(iris[,c("Sepal.Width","Sepal.Length","Petal.Width")]), 
            yt = iris[,"Petal.Length"], 
            yt.axis.name = "Petal.Length",
            membership.cols = iris[,"Species"], 
            cluster.rows = FALSE,
            yr = iris.coef[-1], # plot the model coefficients above
            yr.plot.type = "bar", # make the plot above a barplot
            yr.axis.name = "coefficient",
            bottom.label.pal = "white")
```





--------

## Customizing the plot
Below we continue with the iris example and show how to use the numerous options for customizing the plot


### Clustering options (row *and* column)

In the `iris` example above, we have specified our own cluster vector (the `Species` variable which consists of three classes: Setosa, Versicolor and Virginica). However, if you do not have a cluster membership vector in mind (or cannot be bothered to generate one using your clustering algorithm of preference), never fear! The `superheat` function has in-built clustering options for performing K-means (the default if a membership vector is not supplied) and hierarchical clustering (specify `clustering.method = "hierarchical"`) on the rows and/or columns.\\



```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
set.seed(134)
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"], 
            yr.axis.name = "Petal.Length",
            n.clusters.rows = 3,
            clustering.method = "kmeans")

```


Again we note that, by default, if no membership vectors are supplied, the default is to cluster the rows but not the columns. As a result, the number of row clusters must be supplied (above we have `n.clusters.rows = 3`), otherwise an error will be produced. If you wish to cluster the columns also, you could specify a number of column clusters using the `n.cluster.col` argument.


If you wanted to keep the variable names as the labels, you could simply specify `bottom.heat.label = "variable"`.

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
set.seed(134)
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"], 
            yr.axis.name = "Petal.Length",
            n.clusters.rows = 3,
            n.clusters.col = 2,
            bottom.heat.label = "variable")
```


Moreover, if you have used the in-built clustering algorithms, you can obtain the clustering membership vector by saving the `superheat` object and acessing the `membership` element (below we hide the plot itself, which is the same as the previous plot, by specifying `print.plot = F`).

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
set.seed(134)
plot <- superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"], 
            yr.axis.name = "Petal.Length",
            n.clusters.rows = 3,
            print.plot = F)
plot$membership.rows
```


We note that the k-means clustering corresponds mostly to the Species variable.



### Plot types

The top/right plots can be one of several types. The default is a scatterplot. The following other options are also available:

* A scatterplot with loess smoothed curve
```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.plot.type = "scattersmooth")
```

* A scatterplot with fitted line

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.plot.type = "scattersmooth",
            smoothing.method = "lm")
```

* A smoothed curve

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.plot.type = "smooth")
```

* A line

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.plot.type = "line")
```


* A line with points

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.plot.type = "scatterline")
```

* A barplot (this typically makes more sense for variables)

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.plot.type = "bar",
            yr.bar.col = "grey")
```


* A boxplot

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.plot.type = "boxplot")
```


### Layout



It is not necessary to have all components at all times in your plot. For example, if you do not supply a `yt` vector, no top scatterplot is provided. Similarly if you do not supply a  `yr` vector. Further options include:

* You can remove the legend:


```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"], 
            yr.axis.name = "Petal.Length",
            membership.rows = iris[,"Species"],
            legend = FALSE)
```


* You can remove the left cluster/variable labels

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"], 
            yr.axis.name = "Petal.Length",
            membership.rows = iris[,"Species"],
            left.heat.label = "none")
```

* You can remove the bottom cluster/variable labels

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"], 
            yr.axis.name = "Petal.Length",
            membership.rows = iris[,"Species"],
            bottom.heat.label = "none")
```


* You can remove the scatterplot axis (similarly for the top axis)

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis = F)
```

* You can add a title

```{r, fig.align='center',fig.height = 5, fig.width = 6,  fig.show = 'hold'}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            title = "I'm a title!")
```




* You can add white padding (in cm) around the plot (the default is 2cm):

```{r, fig.align = 'center', fig.height = 5, fig.width = 6}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            padding = 2.5)
```


* you can remove the cluster boxes:


```{r, fig.align = 'center', fig.height = 5, fig.width = 6}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            cluster.box = FALSE)
```

### Colour palattes

The default colour palates are as shown in the above examples, however the user can specify their own colour palates:

 * There are a number of optional colour schemes for the heatmap including "red" (the default), "purple", "blue" (shown below), "grey" and "green". These can be specified using the `heat.col.scheme` argument.
 
 
```{r, fig.align = 'center', fig.height = 5, fig.width = 6}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            heat.col.scheme = "blue")
```

* You can also specify your own colour scheme for the heatmap using the `heat.pal` argument. You can specify as many colours as you want.

 
```{r, fig.align = 'center', fig.height = 5, fig.width = 6}
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            heat.pal = c("yellow", "brown", "blue")) 
```

* If your data are centered around 0 (e.g. standardized values), you may want to use a diverging palette. You can do this using the `heat.pal` and `heat.pal.values` arguments, specifying that the center of your palette should be at 0.

```{r, fig.align = 'center', fig.height = 5, fig.width = 6}
library(RColorBrewer)
scaled_iris <- scale(iris[,c("Sepal.Width","Sepal.Length","Petal.Width")])
superheat(X = scaled_iris, 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            heat.pal = brewer.pal(9, "RdBu"),
            heat.pal.values = c(0,  (-min(scaled_iris))/diff(range(scaled_iris)), 1))
```

*  You can specify the colour of the points in the scatterplot (replace `yr` with `yt` for the top scatterplot). Note that the order of the points in the `yr.obs.col` vector correspond to the order of the points in `yr`.


```{r, fig.align = 'center', fig.height = 5, fig.width = 6}
col.vec <- rep("black", 150)
col.vec[50:70] <- "red"

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.obs.col = col.vec)
```



*  Or you can simply specify the colour for each cluster of `yr`.


```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.pal = c("red","blue","orange"))
```


* You can specify the cluster label (and variable label) colors. (The equivalent for the bottom labels can be specified using `bottom.label.pal` and `bottom.label.text.col`)



```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            left.label.pal = c("blue","red","purple"),
            left.label.text.col = c("white","black","white"))
```


* You can specify the colour of the cluster boxes

```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            box.col = "white")
```

### Sizing

There are a number of options to change the text size, point size and legend size in the plot. For example, you can specify the following arguments in the `superheat` function:


* You can change the legend size


```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            legend.size = 4)
```


* You can change the cluster/variable label size (the default is 0.1) and the label text angle

```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            bottom.label.size = 0.5,
            bottom.text.angle = 90,
            left.label.size = 0.4,
            left.text.angle = 0)
```


* You can change the cluster/variable label text size (the default is 5)


```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            left.text.size = 7,
            bottom.text.size = 2)
```


* You can change the scatterplot axis size and the axis label size (the default for both is 10). 


```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.axis.size = 15,
            yr.axis.name.size = 20)
```

* you can change the point size

```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            yr.point.size = 3.5)
```


* You can change the thickness of the cluster boxes

```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            box.size = 2)
```

### Ordering

* you can change order of observations within each cluster. For example, we can order the observations by Sepal.Width

```{r, fig.align = 'center', fig.height = 5, fig.width = 6}

superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            order.rows = order(iris$Sepal.Width))
```


## Saving the images

The best format for saving superheat images is as a .png file. To do this in R, the easiest way is to envoke the `png()` function (remember to call `dev.off()` when you're done!)

```{r, fig.align = 'center', fig.height = 5, fig.width = 6, eval = FALSE}

png("superheat.png", height = 500, width = 800)
superheat(X = iris[,c("Sepal.Width","Sepal.Length","Petal.Width")], 
            yr = iris[,"Petal.Length"],
            membership.rows = iris[,"Species"],
            yr.axis.name = "Petal.Length",
            order.rows = order(iris$Sepal.Width))
dev.off()
```




--------

## The end

Thanks for using the package! I hope you find it helpful in your data exploration adventures. The development page can be found at <https://github.com/rlbarter/superheat>. For pull requests and suggestions please follow the standard protocol. For pressing questions or comments feel free to email me at rebeccabarter@berkeley.edu.



--------


<!-- 

tools::compactPDF("vignettes/", gs_quality = "ebook")
rmarkdown::render("Vignettes/Vignette.Rmd", c("html_document"))



--> 
